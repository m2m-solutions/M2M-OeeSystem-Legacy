<%@ Control Language="C#" AutoEventWireup="true" CodeBehind="MachineFilterControl.ascx.cs" Inherits="M2M.DataCenter.WebUI.Production.MachineFilterControl" EnableViewState="false" %>
<%@ Register Assembly="Telerik.Web.UI" Namespace="Telerik.Web.UI" TagPrefix="telerik" %>
<script type="text/javascript"> 
	function HandleRequest(sender, eventArgs)
	{
		sender.clearItems();
		var context = eventArgs.get_context();
		
		var articlesFilter = eventArgs.get_text();
	
		if(articlesFilter != null)
		{
			context["ArticlesFilter"] = articlesFilter;
		}
		
		var startDatePicker = $find("<%= dtStart.ClientID %>");
		var startDate = startDatePicker.get_selectedDate();
		
		if (startDate != null)
		{
			context["StartDate"] = startDate.toLocaleString();
		}
		
		var endDatePicker = $find("<%= dtEnd.ClientID %>");
		var endDate = endDatePicker.get_selectedDate();
		
		if (endDate != null)
		{
			context["EndDate"] = endDate.toLocaleString();
		}
		
		var shiftCombo = $find("<%= ProductionShifts.ClientID %>");
		var shift = shiftCombo.get_value();
		
		if (shift != null)
		{
			context["Shift"] = shift;
		}
	}
	
	function HandleOpen(sender, eventArgs)
    {
		sender.requestItems(sender.get_text(), false);
}

    function onLoad(sender) {
        sender.get_inputDomElement().readOnly = "readonly";
    }

    function StopPropagation(e) {
        //cancel bubbling
        e.cancelBubble = true;
        if (e.stopPropagation) {
            e.stopPropagation();
        }
    }

    function onCheckBoxClick() {
        var combo = $find("<%= cbCategories.ClientID %>");
        //holds the text of all checked items
        var text = "";
        //holds the values of all checked items
        var values = "";
        //get the collection of all items
        var items = combo.get_items();
        // holds the total number of items
        var count = items.get_count();
        // holds the number of selected items
        var selected = 0;
        //enumerate all items
        for (var i = 0; i < count; i++) {
            var item = items.getItem(i);
            //get the checkbox element of the current item
            var chk1 = $get(combo.get_id() + "_i" + i + "_chk1");
            if (chk1.checked) {
                text += item.get_text() + ",";
                selected++;
            }
        }


        if (selected > 0 && selected < count) {
            //remove the last comma from the string
            text = removeLastComma(text);
            //set the text of the combobox
            combo.set_text(text);
        }
        else if (selected == 0) {
            //no checkboxes are checked
            combo.set_text("Visa ej larm");
        } else {

            // all checkboxes are checked
            combo.set_text("Visa alla larm");
        }

    }


    //this method removes the ending comma from a string
    function removeLastComma(str) {
        return str.replace(/,$/, "");
    }

    function onRefreshClick() {
        var combo = $find("<%= cbCategories.ClientID %>");
        var check = $get("<%= checkInfo.ClientID %>");
        var valid = (check.checked || combo.get_text() != "Visa ej larm");
        if (valid) {
            return true;
        }
        else
        {
            alert("Obs! Inga händelser valda.\n\nVälj att visa larm och/eller information.");
            return false;
        } 
        
    }
</script>
<div class="white_frame">
	<div class="header">
		<div class="top">
			<div class="bottom">
				<div class="left">
					<div class="right">
						<div class="bottomleft">
							<div class="bottomright">
								<div class="topleft">
									<div class="topright">
										<div class="content">
											<div class="filterView">
												<div class="item">
													<div class="label">
														<asp:Label ID="lbDateStart" runat="server" Text="Datum, start"></asp:Label>
													</div>
													<div class="input">
														<telerik:RadDatePicker ID="dtStart" Width="100px" runat="server" Skin="Default" AutoPostBack="False">
														</telerik:RadDatePicker>
													</div>
												</div>
												<div class="item">
													<div class="label">
														<asp:Label ID="lbDateEnd" runat="server" Text="Datum, slut"></asp:Label>
													</div>
													 <div class="input">
														<telerik:RadDatePicker ID="dtEnd" Width="100px" Skin="Default" AutoPostBack="False" runat="server">
														</telerik:RadDatePicker>
													</div>
												</div>
												<div class="item">
													<div class="label">
														<asp:Label ID="lbShift" runat="server" Text="Skift"></asp:Label>
													</div>
													 <div class="input">
														<telerik:RadComboBox ID="ProductionShifts" Width="190px" Skin="Default" AutoPostBack="False" runat="server">
															 <CollapseAnimation Duration="200" Type="OutQuint" />
														 </telerik:RadComboBox>
													</div>
												</div>
												<div class="item">
													<div class="label">
														<asp:Label ID="lbArticle" runat="server" Text="Artikel"></asp:Label>
													</div>
													 <div class="input">
														 <telerik:RadComboBox ID="rcbArticles"  OnClientDropDownOpening="HandleOpen" OnClientItemsRequesting="HandleRequest" LoadingMessage="Laddar..." Width="130px" EnableLoadOnDemand="True" ShowMoreResultsBox="False" ItemRequestTimeout="500" MarkFirstMatch="True" AllowCustomText="True" runat="server" Skin="Default">
															  <WebServiceSettings Path="Articles.asmx" Method="GetMachineArticles" />
															  <CollapseAnimation Duration="200" Type="OutQuint" />
														 </telerik:RadComboBox>
													</div>
												</div>
												<div class="last">
													<div class="button">
														<asp:Button ID="btnRefresh" runat="server" CssClass="buttonSmallWhiteOnWhite" OnClientClick="onRefreshClick()" Text="Uppdatera" OnClick="btnRefresh_Click" />
													</div>
												</div>
												<div class="divider" style="height:10px"></div>
												<div class="item">
													<div class="label">
														<asp:CheckBox ID="checkExcludeNoProduction" runat="server" Checked="True" Text="Ignorera icke-producerande tid" />
													</div>
												</div>
												<div class="item">
													 <div class="label">
														 <asp:CheckBox ID="checkInfo" runat="server" Checked="True" Text="Information" />
													</div>
													
												</div>
												<div class="item">
													<div class="input">
														<telerik:RadComboBox ID="cbCategories" runat="server" DataSourceID="SqlDataSource1"
                                                            DataValueField="CategoryId" DataTextField="DisplayName" AllowCustomText="true" 
                                                             EmptyMessage="Visa ej larm" Width="240px" 
                                                             EnableTextSelection="False"  ChangeTextOnKeyBoardNavigation="false" 
                                                            LoadingMessage="Laddar..." OnClientLoad="onLoad"
                                                            onprerender="cbCategories_PreRender">
                                                            <ItemTemplate>
                                                                <div onclick="StopPropagation(event)" >
                                                                    <asp:CheckBox runat="server" ID="chk1" Checked="true" onclick="onCheckBoxClick()"/>
                                                                    <asp:Label runat="server" ID="Label1" AssociatedControlID="chk1">
                                                                        <%# Eval("DisplayName") %>
                                                                    </asp:Label>
                                                                </div>
                                                            </ItemTemplate>
                                                        </telerik:RadComboBox>
													</div>
												</div>
												
												<div class="divider"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="clear">&nbsp;</div>
	</div>
</div>
<asp:SqlDataSource ID="SqlDataSource1" runat="server" 
    ConnectionString="<%$ ConnectionStrings:M2M.DataCenter %>" 
    SelectCommand="SELECT [CategoryId], [DisplayName] FROM [EventCategories]">
</asp:SqlDataSource>